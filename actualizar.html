<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualización de Datos</title>
    <link rel="icon" href="https://raw.githubusercontent.com/appsparavos-ops/DSC/fotos/update.png" type="image/pn>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); max-width: 600px; margin: 50px auto; text-align: center; }
        h1, h2 { color: #0056b3; margin-bottom: 20px; }
        input[type="file"], input[type="email"], input[type="password"], input[type="text"] { display: block; margin: 10px auto; padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: calc(100% - 22px); }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; margin: 5px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #message { margin-top: 20px; padding: 10px; border-radius: 4px; background-color: #e9ecef; color: #333; min-height: 30px; text-align: left; word-wrap: break-word; }
        .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .hidden { display: none; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Actualización de Datos</h1>

        <div id="loginSection">
            <h2>Login para Continuar</h2>
            <input type="email" id="emailInput" placeholder="Email">
            <input type="password" id="passwordInput" placeholder="Password">
            <button id="loginButton">Login</button>
            <p id="loginMessage" class="error"></p>
        </div>

        <div id="choiceSection" class="hidden">
            <h2>Selecciona una acción</h2>
            <button id="choiceUploadButton">Subir Registros de Temporada</button>
            <button id="choiceReplaceButton">Actualizar Datos Personales</button>
            <button id="choiceDeleteButton" class="btn-danger">Borrar Registro</button>
            <button id="logoutButton">Logout</button>
        </div>

        <div id="uploadSection" class="hidden">
            <h2 id="uploadTitle"></h2>
            <input type="text" id="seasonInput" placeholder="Temporada (ej. 2025)" class="hidden">
            <input type="file" id="csvFile" accept=".csv">
            <button id="performActionButton" disabled>Ejecutar</button>
            <button id="backButton">Volver</button>
            <div id="message"></div>
        </div>

        <div id="deleteSection" class="hidden">
            <h2>Borrar Registro de Temporada</h2>
            <input type="text" id="deleteSeasonInput" placeholder="Temporada (ej. 2025)">
            <input type="text" id="deleteDniInput" placeholder="DNI">
            <button id="searchRecordsButton">Buscar Registros</button>
            <div id="recordsList" style="margin-top: 20px; text-align: left;"></div>
            <button id="backFromDeleteButton">Volver</button>
            <div id="deleteMessage" style="margin-top: 20px; padding: 10px; border-radius: 4px;"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyANWXQvhHpF0LCYjz4AXi3MkcP798PqRfA",
            authDomain: "dsc24-aa5a1.firebaseapp.com",
            databaseURL: "https://dsc24-aa5a1-default-rtdb.firebaseio.com",
            projectId: "dsc24-aa5a1",
            storageBucket: "dsc24-aa5a1.appspot.com",
            messagingSenderId: "798100493177",
            appId: "1:798100493177:web:8e2ae324f8b5cb893a55a8"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // --- LÓGICA DE BITÁCORA ---
        function getTimestampKey() {
            const now = new Date();
            const timestamp = now.getFullYear().toString() +
                   String(now.getMonth() + 1).padStart(2, '0') +
                   String(now.getDate()).padStart(2, '0') +
                   String(now.getHours()).padStart(2, '0') +
                   String(now.getMinutes()).padStart(2, '0') +
                   String(now.getSeconds()).padStart(2, '0');
            const randomPart = Math.random().toString(36).substring(2, 7); // 5 random chars
            return `${timestamp}-${randomPart}`;
        }

        function logAction(action, details) {
            const user = auth.currentUser;
            if (!user) return;

            const timestampKey = getTimestampKey();
            const logEntry = {
                usuario: user.email,
                uid: user.uid,
                accion: action,
                fecha: new Date().toISOString(),
                detalles: details
            };

            const logRef = database.ref(`/bitacora/${timestampKey}`);
            logRef.set(logEntry).catch(error => {
                console.error("Error al escribir en la bitácora:", error);
            });
        }


        const loginSection = document.getElementById('loginSection');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');
        
        const choiceSection = document.getElementById('choiceSection');
        const choiceUploadButton = document.getElementById('choiceUploadButton');
        const choiceReplaceButton = document.getElementById('choiceReplaceButton');
        const choiceDeleteButton = document.getElementById('choiceDeleteButton');
        const logoutButton = document.querySelector('#choiceSection #logoutButton');

        const uploadSection = document.getElementById('uploadSection');
        const uploadTitle = document.getElementById('uploadTitle');
        const seasonInput = document.getElementById('seasonInput');
        const csvFile = document.getElementById('csvFile');
        const performActionButton = document.getElementById('performActionButton');
        const backButton = document.getElementById('backButton');
        const messageDiv = document.getElementById('message');

        const deleteSection = document.getElementById('deleteSection');
        const deleteSeasonInput = document.getElementById('deleteSeasonInput');
        const deleteDniInput = document.getElementById('deleteDniInput');
        const searchRecordsButton = document.getElementById('searchRecordsButton');
        const recordsList = document.getElementById('recordsList');
        const backFromDeleteButton = document.getElementById('backFromDeleteButton');
        const deleteMessageDiv = document.getElementById('deleteMessage');

        let parsedData = [];
        let currentAction = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                loginSection.classList.add('hidden');
                uploadSection.classList.add('hidden');
                deleteSection.classList.add('hidden');
                choiceSection.classList.remove('hidden');
                messageDiv.textContent = '';
                messageDiv.className = '';
            } else {
                loginSection.classList.remove('hidden');
                uploadSection.classList.add('hidden');
                deleteSection.classList.add('hidden');
                choiceSection.classList.add('hidden');
                emailInput.value = '';
                passwordInput.value = '';
            }
        });

        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) {
                loginMessage.textContent = 'Por favor, introduce email y contraseña.';
                return;
            }
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    logAction('login', { email: userCredential.user.email, origin: 'actualizar.html' });
                    loginMessage.textContent = '';
                })
                .catch(error => {
                    loginMessage.textContent = `Error de inicio de sesión: ${error.message}`;
                });
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        choiceUploadButton.addEventListener('click', () => {
            currentAction = 'upload';
            choiceSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            seasonInput.classList.remove('hidden');
            uploadTitle.textContent = 'Subir Registros de Temporada';
            performActionButton.textContent = 'Subir a Firebase';
            showMessage('Sube un CSV para añadir nuevos registros de temporada (altas, bajas, etc.). Esto creará nuevas entradas.', '');
        });

        choiceReplaceButton.addEventListener('click', () => {
            currentAction = 'replace';
            choiceSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            seasonInput.classList.add('hidden');
            uploadTitle.textContent = 'Actualizar Datos Personales';
            performActionButton.textContent = 'Actualizar Datos';
            showMessage('Sube un CSV con DNI y los datos personales a actualizar. Esto NO afectará los datos de temporada.', '');
        });

        choiceDeleteButton.addEventListener('click', () => {
            choiceSection.classList.add('hidden');
            deleteSection.classList.remove('hidden');
            deleteSeasonInput.value = '';
            deleteDniInput.value = '';
            recordsList.innerHTML = '';
            deleteMessageDiv.textContent = '';
        });

        backButton.addEventListener('click', () => {
            uploadSection.classList.add('hidden');
            choiceSection.classList.remove('hidden');
            csvFile.value = '';
            seasonInput.value = '';
            seasonInput.classList.add('hidden');
            performActionButton.disabled = true;
            parsedData = [];
            currentAction = null;
            showMessage('', '');
        });

        backFromDeleteButton.addEventListener('click', () => {
            deleteSection.classList.add('hidden');
            choiceSection.classList.remove('hidden');
        });

        csvFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                performActionButton.disabled = false;
                showMessage('Archivo seleccionado. Haz clic en el botón para proceder.', '');
                readCSV(file);
            } else {
                performActionButton.disabled = true;
            }
        });

        performActionButton.addEventListener('click', () => {
            if (parsedData.length === 0) {
                showMessage('Por favor, selecciona un archivo CSV primero.', 'error');
                return;
            }
            if (currentAction === 'upload') {
                const season = seasonInput.value.trim();
                if (!season) {
                    showMessage('Por favor, ingresa la temporada.', 'error');
                    return;
                }
                performActionButton.disabled = true;
                uploadToFirebase(parsedData, season);
            } else if (currentAction === 'replace') {
                performActionButton.disabled = true;
                replacePersonalData(parsedData);
            }
        });

        function readCSV(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    parsedData = parseCSV(e.target.result);
                    showMessage(`Archivo CSV cargado. Se encontraron ${parsedData.length} filas válidas.`, 'success');
                } catch (error) {
                    showMessage(`Error al procesar el CSV: ${error.message}`, 'error');
                    parsedData = [];
                    performActionButton.disabled = true;
                }
            };
            reader.onerror = () => showMessage('Error al leer el archivo.', 'error');
            reader.readAsText(file, 'ISO-8859-1');
        }

        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error('El archivo CSV está vacío o no tiene datos.');
            const headers = lines[0].split(';').map(header => header.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(';').map(value => value.trim());
                if (values.length > headers.length) {
                    values.length = headers.length;
                }
                const rowObject = headers.reduce((obj, header, index) => {
                    if(header) obj[header] = values[index] || '';
                    return obj;
                }, {});
                
                // Normalizar nombres de columnas para DNI/NIF, CATEGORIA/CATEGORÍA, etc.
                if (rowObject.NIF && !rowObject.DNI) {
                    rowObject.DNI = rowObject.NIF;
                }
                if (rowObject['CATEGORÍA'] && !rowObject.CATEGORIA) {
                    rowObject.CATEGORIA = rowObject['CATEGORÍA'];
                }
                if (rowObject['COMPETICIÓN'] && !rowObject.COMPETICION) {
                    rowObject.COMPETICION = rowObject['COMPETICIÓN'];
                }
                if (rowObject[' NOMBRE'] && !rowObject.NOMBRE) {
                    rowObject.NOMBRE = rowObject[' NOMBRE'];
                }
                if (rowObject.FECHA_LIC && !rowObject.FECHA_ALTA) {
                    rowObject.FECHA_ALTA = rowObject.FECHA_LIC;
                }

                if (!rowObject.DNI) continue; // DNI is always mandatory

                if (currentAction === 'upload' && !rowObject.TIPO) {
                   console.warn('Skipping row for upload action due to missing TIPO:', rowObject);
                   continue;
                }
                
                data.push(rowObject);
            }
            return data;
        }

        function replacePersonalData(data) {
            showMessage('Procesando y actualizando datos personales...', '');
            const allUpdates = {};
            let processedCount = 0;
            const personalKeys = ['NOMBRE', 'FECHA NACIMIENTO', 'NACIONALIDAD', 'TELEFONO', 'EMAIL', 'FM Desde', 'FM Hasta'];

            data.forEach(row => {
                const dni = row.DNI.trim();
                const tipo = row.TIPO ? row.TIPO.trim().toUpperCase() : 'JUGADOR';
                const rootNode = tipo === 'ENTRENADOR/A' ? 'entrenadores' : 'jugadores';

                let hasDataToUpdate = false;
                personalKeys.forEach(key => {
                    if (row[key] !== undefined && row[key] !== null) {
                        const path = `/${rootNode}/${dni}/datosPersonales/${key}`;
                        allUpdates[path] = row[key];
                        hasDataToUpdate = true;
                    }
                });
                if(hasDataToUpdate) {
                    processedCount++;
                }
            });

            if (Object.keys(allUpdates).length === 0) {
                showMessage('No se encontraron datos para actualizar. Revisa que el CSV tenga DNI y columnas con datos personales.', 'error');
                performActionButton.disabled = false;
                return;
            }

            database.ref().update(allUpdates)
                .then(() => {
                    const message = `¡Datos personales de ${processedCount} registros procesados correctamente!`;
                    showMessage(message, 'success');
                    logAction('replace_personal_data', { count: processedCount, message: message });
                    performActionButton.disabled = false;
                })
                .catch((error) => {
                    showMessage(`Error al actualizar los datos: ${error.message}`, 'error');
                    console.error("Error during Firebase bulk update: ", error);
                    performActionButton.disabled = false;
                });
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }

        async function uploadToFirebase(data, manualSeason) {
            showMessage('Filtrando registros del CSV para obtener el más reciente...', '');

            const latestRecordsMap = new Map();
            data.forEach(row => {
                const dni = row.DNI ? row.DNI.trim() : null;
                const categoria = row.CATEGORIA ? row.CATEGORIA.trim() : '';
                if (!dni) return;

                const key = `${dni}|${categoria}`;
                const existingRecord = latestRecordsMap.get(key);

                if (!existingRecord) {
                    latestRecordsMap.set(key, row);
                    return;
                }

                const currentDate = parseDate(row.FECHA_ALTA);
                const storedDate = parseDate(existingRecord.FECHA_ALTA);

                if (currentDate && storedDate) {
                    if (currentDate.getTime() > storedDate.getTime()) {
                        latestRecordsMap.set(key, row);
                    } else if (currentDate.getTime() === storedDate.getTime()) {
                        const currentBajaDate = parseDate(row.BAJA);
                        const storedBajaDate = parseDate(existingRecord.BAJA);

                        if (currentBajaDate && !storedBajaDate) {
                            latestRecordsMap.set(key, row);
                        } else if (currentBajaDate && storedBajaDate && currentBajaDate.getTime() > storedBajaDate.getTime()) {
                            latestRecordsMap.set(key, row);
                        }
                    }
                } else if (currentDate) {
                    latestRecordsMap.set(key, row);
                }
            });

            const filteredData = Array.from(latestRecordsMap.values());
            showMessage(`CSV filtrado. ${filteredData.length} registros únicos para procesar.`, 'success');
            
            // Re-utilizar el nombre 'data' para el resto de la función
            data = filteredData;

            showMessage('Verificando duplicados en Firebase...', '');
            
            const temporadaRef = database.ref(`registrosPorTemporada/${manualSeason}`);
            let existingRecords = {};
            
            try {
                const snapshot = await temporadaRef.once('value');
                if (snapshot.exists()) {
                    const val = snapshot.val();
                    Object.values(val).forEach(record => {
                        const dni = record._dni || record.DNI;
                        if (dni) {
                            if (!existingRecords[dni]) existingRecords[dni] = [];
                            existingRecords[dni].push(record);
                        }
                    });
                }
            } catch (error) {
                console.error("Error fetching existing records:", error);
                showMessage(`Error al verificar duplicados: ${error.message}`, 'error');
                performActionButton.disabled = false;
                return;
            }

            showMessage('Procesando y subiendo datos a Firebase...', '');
            
            const allUpdates = {};
            let processedCount = 0;
            let skippedCount = 0;

            const personalKeys = ['DNI', 'NOMBRE', 'FECHA NACIMIENTO', 'NACIONALIDAD', 'TELEFONO', 'EMAIL', 'FM Desde', 'FM Hasta'];
            const seasonalKeys = ['COMPETICION', 'CATEGORIA', 'EQUIPO', 'ESTADO LICENCIA', 'FECHA_ALTA', 'BAJA', 'TIPO', 'TEMPORADA', 'Numero', 'Numeros', 'categoriasAutorizadas'];

            data.forEach(row => {
                const rootNode = row.TIPO.trim().toUpperCase() === 'ENTRENADOR/A' ? 'entrenadores' : 'jugadores';
                const dni = row.DNI.trim();
                const temporada = manualSeason;
                const categoria = row.CATEGORIA ? row.CATEGORIA.trim() : '';
                const estadoLicencia = row['ESTADO LICENCIA'] ? row['ESTADO LICENCIA'].trim() : '';
                const fechaAltaStr = row.FECHA_ALTA ? row.FECHA_ALTA.trim() : '';
                const fechaAlta = parseDate(fechaAltaStr);

                let targetPushId = null;
                let isUpdate = false;
                let accumulatedNumeros = {};

                if (existingRecords[dni]) {
                    // 1. Recolectar números existentes de todas las categorías de este jugador en esta temporada
                    existingRecords[dni].forEach(r => {
                        if (r.Numeros) {
                            Object.assign(accumulatedNumeros, r.Numeros);
                        } else if (r.Numero && r.CATEGORIA) {
                            accumulatedNumeros[r.CATEGORIA] = r.Numero;
                        }
                    });

                    // 2. Buscar si ya existe un registro para esta categoría
                    const match = existingRecords[dni].find(r => r.CATEGORIA === categoria);

                    if (match) {
                        const oldFechaStr = match.FECHA_ALTA || '';
                        const oldFecha = parseDate(oldFechaStr);

                        // Lógica: Si la fecha del CSV es mayor a la de Firebase, actualizamos.
                        if (fechaAlta && oldFecha && fechaAlta > oldFecha) {
                            isUpdate = true;
                            targetPushId = match._pushId;
                            console.log(`Actualizando registro para DNI ${dni}, Cat ${categoria} (Nueva fecha: ${fechaAltaStr} > ${oldFechaStr})`);
                        } else {
                            // Si no es más reciente, verificamos si es un duplicado exacto para omitir
                            const recEstado = match['ESTADO LICENCIA'] || '';
                            if (recEstado === estadoLicencia) {
                                console.log(`Omitiendo duplicado para DNI ${dni}, Temporada ${temporada}, Cat ${categoria}, Estado ${estadoLicencia}`);
                                skippedCount++;
                                return; // Saltar esta fila
                            }
                        }
                    }
                }

                const seasonalData = {};

                personalKeys.forEach(key => {
                    if (row[key] !== undefined) {
                        allUpdates[`/${rootNode}/${dni}/datosPersonales/${key}`] = row[key];
                    }
                });
                seasonalKeys.forEach(key => { if (row[key] !== undefined) seasonalData[key] = row[key]; });
                seasonalData.TEMPORADA = temporada;

                // 3. Gestionar Números (Mezclar nuevos con existentes)
                if (seasonalData.Numero) {
                    accumulatedNumeros[categoria] = seasonalData.Numero;
                }
                if (Object.keys(accumulatedNumeros).length > 0) {
                    seasonalData.Numeros = accumulatedNumeros;
                }
                delete seasonalData.Numero;

                // 4. Definir ID (Nuevo o Existente)
                const newPushKey = targetPushId || database.ref().child(rootNode).child(dni).child('temporadas').child(temporada).push().key;
                const firebaseKey = `${dni}|${newPushKey}`;

                const combinedDataForIndex = {
                    ...seasonalData,
                    _firebaseKey: firebaseKey,
                    _tipo: rootNode,
                    _dni: dni,
                    _pushId: newPushKey
                };

                allUpdates[`/${rootNode}/${dni}/temporadas/${temporada}/${newPushKey}`] = seasonalData;
                allUpdates[`/registrosPorTemporada/${temporada}/${newPushKey}`] = combinedDataForIndex;
                allUpdates[`/temporadas/${temporada}`] = true;
                
                processedCount++;
            });

            if (Object.keys(allUpdates).length === 0) {
                if (skippedCount > 0) {
                    showMessage(`No se procesaron datos nuevos. ${skippedCount} registros ya existían en la temporada.`, 'success');
                } else {
                    showMessage('No se procesó ningún dato. Revisa que las filas del CSV tengan DNI y TIPO.', 'error');
                }
                performActionButton.disabled = false;
                return;
            }

            database.ref().update(allUpdates)
                .then(() => {
                    let msg = `¡${processedCount} registros se han procesado y subido correctamente a Firebase!`;
                    if (skippedCount > 0) msg += ` Se omitieron ${skippedCount} registros duplicados.`;
                    showMessage(msg, 'success');
                    logAction('upload_season_data', { 
                        season: manualSeason, 
                        processed: processedCount, 
                        skipped: skippedCount,
                        message: msg 
                    });
                    performActionButton.disabled = false;
                })
                .catch((error) => {
                    showMessage(`Error al subir los datos: ${error.message}`, 'error');
                    console.error("Error during Firebase bulk update: ", error);
                    performActionButton.disabled = false;
                });
        }

        function showMessage(msg, type = '') {
            messageDiv.textContent = msg;
            messageDiv.className = type;
        }

        searchRecordsButton.addEventListener('click', () => {
            const season = deleteSeasonInput.value.trim();
            const dni = deleteDniInput.value.trim();
            
            if (!season || !dni) {
                showDeleteMessage('Por favor, ingresa Temporada y DNI.', 'error');
                return;
            }
            
            searchRecords(season, dni);
        });

        function showDeleteMessage(msg, type) {
            deleteMessageDiv.textContent = msg;
            deleteMessageDiv.className = type;
        }

        async function searchRecords(season, dni) {
            showDeleteMessage('Buscando...', '');
            recordsList.innerHTML = '';

            let type = 'jugadores';
            let snapshot = await database.ref(`jugadores/${dni}/temporadas/${season}`).once('value');
            
            if (!snapshot.exists()) {
                type = 'entrenadores';
                snapshot = await database.ref(`entrenadores/${dni}/temporadas/${season}`).once('value');
            }

            if (!snapshot.exists()) {
                showDeleteMessage('No se encontraron registros para ese DNI en esa temporada.', 'error');
                return;
            }

            showDeleteMessage(`Se encontraron registros en ${type}.`, 'success');
            const records = snapshot.val();
            
            Object.keys(records).forEach(key => {
                const record = records[key];
                const div = document.createElement('div');
                div.style.border = '1px solid #ddd';
                div.style.padding = '10px';
                div.style.marginBottom = '10px';
                div.style.borderRadius = '4px';
                div.style.backgroundColor = '#f9f9f9';
                
                let info = `<strong>ID:</strong> ${key}<br>`;
                info += `<strong>Categoría:</strong> ${record.CATEGORIA || 'N/A'}<br>`;
                info += `<strong>Equipo:</strong> ${record.EQUIPO || 'N/A'}<br>`;
                info += `<strong>Estado:</strong> ${record['ESTADO LICENCIA'] || 'N/A'}<br>`;
                
                div.innerHTML = info;

                const delBtn = document.createElement('button');
                delBtn.textContent = 'Eliminar este registro';
                delBtn.className = 'btn-danger';
                delBtn.style.marginTop = '10px';
                delBtn.onclick = () => deleteRecord(season, dni, type, key, div);
                
                div.appendChild(delBtn);
                recordsList.appendChild(div);
            });
        }

        function deleteRecord(season, dni, type, pushId, elementToRemove) {
            if(!confirm('¿Estás seguro de que quieres eliminar este registro? Esta acción no se puede deshacer.')) return;

            const updates = {};
            updates[`/registrosPorTemporada/${season}/${pushId}`] = null;
            updates[`/${type}/${dni}/temporadas/${season}/${pushId}`] = null;

            database.ref().update(updates)
                .then(() => {
                    elementToRemove.remove();
                    const message = 'Registro eliminado correctamente.';
                    showDeleteMessage(message, 'success');
                    logAction('delete_record', { 
                        season: season, 
                        dni: dni, 
                        type: type, 
                        pushId: pushId,
                        message: message
                    });
                    if (recordsList.children.length === 0) {
                         showDeleteMessage('No quedan registros para mostrar.', '');
                    }
                })
                .catch(error => {
                    showDeleteMessage(`Error al eliminar: ${error.message}`, 'error');
                });
        }
    </script>
</body>
</html>
