<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Importaci칩n de N칰meros</title>
    <link rel="icon" href="https://raw.githubusercontent.com/appsparavos-ops/DSC/fotos/ImportarNumeros.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Modal de Login -->
    <div id="login-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Iniciar Sesi칩n</h2>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Correo electr칩nico" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <input type="password" id="password-input" placeholder="Contrase침a" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <p id="login-error" class="text-red-500 text-sm hidden"></p>
                <button id="login-btn" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-200">
                    Ingresar
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-2xl bg-white p-8 rounded-xl shadow-lg">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Importaci칩n de N칰meros por Temporada</h1>
            <p class="text-gray-500 mt-2">Copia los n칰meros de la categor칤a principal de los jugadores de una temporada a otra.</p>
        </div>

        <!-- Formulario de Configuraci칩n -->
        <div id="config-form" class="space-y-4">
            <div>
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Configuraci칩n</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="source-season" class="block text-sm font-medium text-gray-700">1. Temporada de Origen (Leer n칰meros desde aqu칤)</label>
                    <select id="source-season" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div>
                    <label for="dest-season" class="block text-sm font-medium text-gray-700">2. Temporada de Destino (Escribir n칰meros aqu칤)</label>
                    <select id="dest-season" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Cargando...</option>
                    </select>
                </div>
            </div>
            
            <div class="flex items-center mt-4">
                <input id="overwrite-existing" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="overwrite-existing" class="ml-2 block text-sm text-gray-900">
                    Sobreescribir n칰meros si ya existen en la temporada de destino
                </label>
            </div>

            <div class="pt-4">
                <button id="start-import-btn" class="w-full justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400" disabled>
                    Iniciar Importaci칩n
                </button>
            </div>
        </div>

        <!-- 츼rea de Progreso y Logs -->
        <div id="progress-log" class="hidden mt-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">Progreso de la Importaci칩n</h2>
            <pre id="log-output" class="mt-4 bg-gray-800 text-white text-sm rounded-md p-4 h-64 overflow-y-auto whitespace-pre-wrap"></pre>
            <div class="mt-2 text-right">
                <button id="download-log-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium underline">Descargar Log (.txt)</button>
            </div>
        </div>
    </div>

    <script>
        // --- L칍GICA DEL SCRIPT ---
        const startBtn = document.getElementById('start-import-btn');
        const logOutput = document.getElementById('log-output');
        const configForm = document.getElementById('config-form');
        const progressLog = document.getElementById('progress-log');
        const sourceSeasonSelect = document.getElementById('source-season');
        const destSeasonSelect = document.getElementById('dest-season');
        
        const loginModal = document.getElementById('login-modal');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const downloadLogBtn = document.getElementById('download-log-btn');

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Funci칩n para a침adir mensajes al log
        function log(message, isError = false) {
            const prefix = isError ? '[ERROR] ' : '[INFO] ';
            console.log(prefix + message);
            logOutput.textContent += prefix + message + '\n';
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Cargar temporadas en los dropdowns
        async function loadSeasons() {
            try {
                const snapshot = await database.ref('/temporadas').once('value');
                if (!snapshot.exists()) {
                    log('No se encontraron temporadas en la base de datos.', true);
                    return;
                }
                const seasons = Object.keys(snapshot.val()).sort((a, b) => b.localeCompare(a)); // Descendente
                sourceSeasonSelect.innerHTML = '<option value="">Seleccione...</option>';
                destSeasonSelect.innerHTML = '<option value="">Seleccione...</option>';
                seasons.forEach(season => {
                    sourceSeasonSelect.add(new Option(season, season));
                    destSeasonSelect.add(new Option(season, season));
                });
            } catch (error) {
                log(`Error al cargar temporadas: ${error.message}`, true);
            }
        }

        // L칩gica de Login
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.classList.add('hidden');
            
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    loginError.textContent = "Error: " + error.message;
                    loginError.classList.remove('hidden');
                });
        });

        // L칩gica de Descarga de Log
        downloadLogBtn.addEventListener('click', () => {
            const text = logOutput.textContent;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `log_importacion_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        });

        // L칩gica de autenticaci칩n para habilitar el bot칩n
        auth.onAuthStateChanged(user => {
            if (user) {
                loginModal.classList.add('hidden');
                database.ref('admins/' + user.uid).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        log('Usuario administrador autenticado. Listo para importar.');
                        startBtn.disabled = false;
                        loadSeasons();
                    } else {
                        log('El usuario no es administrador. La importaci칩n est치 deshabilitada.', true);
                    }
                });
            } else {
                loginModal.classList.remove('hidden');
            }
        });

        // Event listener para el bot칩n de inicio
        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.textContent = 'Importando...';
            configForm.classList.add('hidden');
            progressLog.classList.remove('hidden');

            const sourceSeason = sourceSeasonSelect.value;
            const destSeason = destSeasonSelect.value;
            const overwriteExisting = document.getElementById('overwrite-existing').checked;

            if (!sourceSeason || !destSeason) {
                log('Debe seleccionar una temporada de origen y una de destino.', true);
                startBtn.disabled = false;
                startBtn.textContent = 'Iniciar Importaci칩n';
                return;
            }
            if (sourceSeason === destSeason) {
                log('La temporada de origen y destino no pueden ser la misma.', true);
                startBtn.disabled = false;
                startBtn.textContent = 'Iniciar Importaci칩n';
                return;
            }

            try {
                log(`Iniciando importaci칩n de n칰meros desde ${sourceSeason} hacia ${destSeason}.`);

                // 1. Obtener jugadores de la temporada de origen y mapearlos por DNI
                log(`Paso 1: Obteniendo jugadores de la temporada de origen (${sourceSeason})...`);
                const sourceSnapshot = await database.ref(`/registrosPorTemporada/${sourceSeason}`).once('value');
                if (!sourceSnapshot.exists()) throw new Error(`No se encontraron datos en la temporada de origen ${sourceSeason}.`);
                
                const sourcePlayersMap = new Map();
                Object.values(sourceSnapshot.val()).forEach(player => {
                    if (player._dni && !player.esAutorizado) { // Priorizar el registro principal del jugador
                        sourcePlayersMap.set(String(player._dni), player);
                    }
                });
                log(`Se encontraron ${sourcePlayersMap.size} jugadores principales en la temporada de origen.`);

                // 2. Obtener jugadores de la temporada de destino
                log(`Paso 2: Obteniendo jugadores de la temporada de destino (${destSeason})...`);
                const destSnapshot = await database.ref(`/registrosPorTemporada/${destSeason}`).once('value');
                if (!destSnapshot.exists()) throw new Error(`No se encontraron datos en la temporada de destino ${destSeason}.`);
                const destData = destSnapshot.val();
                log(`Se encontraron ${Object.keys(destData).length} registros para procesar en la temporada de destino.`);

                // 3. Preparar las actualizaciones
                log('Paso 3: Comparando jugadores y preparando actualizaciones...');
                const updates = {};
                let updatedCount = 0;
                let skippedCount = 0;
                const skippedPlayersReport = [];

                for (const pushId in destData) {
                    const destPlayer = destData[pushId];
                    const dni = destPlayer._dni ? String(destPlayer._dni) : null;

                    if (!dni) {
                        const reason = 'Registro sin DNI.';
                        log(`Registro con pushId ${pushId} omitido (${reason})`, true);
                        skippedPlayersReport.push({ name: 'N/A', dni: `(pushId: ${pushId})`, reason: reason });
                        skippedCount++;
                        continue;
                    }

                    // Intentar obtener el nombre del origen si no est치 en el destino
                    const sourcePlayer = sourcePlayersMap.get(dni);
                    let playerName = destPlayer.NOMBRE || (sourcePlayer ? sourcePlayer.NOMBRE : null);

                    if (!playerName) {
                        try {
                            const dbNode = destPlayer._tipo || 'jugadores';
                            const nameSnapshot = await database.ref(`${dbNode}/${dni}/datosPersonales/NOMBRE`).once('value');
                            playerName = nameSnapshot.val();
                        } catch (e) {
                            // Si falla, se mantendr치 como null y pasar치 al valor por defecto
                        }
                    }
                    if (!playerName) playerName = 'Sin Nombre';

                    const destCategory = destPlayer.CATEGORIA;
                    
                    // Verificar si ya tiene n칰mero en destino y si la sobreescritura est치 desactivada
                    const currentDestNumber = (destPlayer.Numeros && destPlayer.Numeros[destCategory]) || destPlayer.Numero;
                    if (currentDestNumber && !overwriteExisting) {
                        const reason = `Ya tiene el n칰mero ${currentDestNumber} y la sobreescritura est치 desactivada.`;
                        log(`Jugador: ${playerName} (${dni}). Omitido. Motivo: ${reason}`);
                        skippedPlayersReport.push({ name: playerName, dni: dni, reason: reason });
                        skippedCount++;
                        continue;
                    }

                    let sourceNumber = null;
                    
                    if (sourcePlayer) {
                        // 1. Priorizar el campo 'Numero' de nivel superior.
                        if (sourcePlayer.Numero) {
                            sourceNumber = sourcePlayer.Numero;
                        } 
                        // 2. Si no existe, buscar dentro del objeto 'Numeros' usando la categor칤a de origen.
                        else if (sourcePlayer.Numeros && sourcePlayer.CATEGORIA && sourcePlayer.Numeros[sourcePlayer.CATEGORIA]) {
                            sourceNumber = sourcePlayer.Numeros[sourcePlayer.CATEGORIA];
                        }
                    }

                    if (sourceNumber) { // Proceder solo si se encontr칩 un n칰mero
                        const dbNode = destPlayer._tipo || 'jugadores';

                        log(`Jugador: ${playerName} (${dni}). N칰mero anterior: ${sourceNumber}. Actualizando...`);
                        
                        const newNumeros = { ...(destPlayer.Numeros || {}) };
                        newNumeros[destCategory] = sourceNumber; // Asignar el n칰mero encontrado a la nueva categor칤a
                        
                        updates[`/registrosPorTemporada/${destSeason}/${pushId}/Numero`] = sourceNumber;
                        updates[`/registrosPorTemporada/${destSeason}/${pushId}/Numeros`] = newNumeros;
                        // Actualizar en el nodo can칩nico del jugador
                        updates[`/${dbNode}/${dni}/temporadas/${destSeason}/${pushId}/Numero`] = sourceNumber;
                        updates[`/${dbNode}/${dni}/temporadas/${destSeason}/${pushId}/Numeros`] = newNumeros;

                        updatedCount++;
                    } else {
                        const reason = 'No encontrado en origen o sin n칰mero v치lido para importar.';
                        log(`Jugador: ${playerName} (${dni}). Omitido. Motivo: ${reason}`);
                        skippedPlayersReport.push({ name: playerName, dni: dni, reason: reason });
                        skippedCount++;
                    }
                }

                // 4. Ejecutar las actualizaciones
                if (Object.keys(updates).length > 0) {
                    log(`Paso 4: Aplicando ${updatedCount} actualizaciones en la base de datos...`);
                    await database.ref().update(updates);
                    log('춰Actualizaciones aplicadas con 칠xito!');
                } else {
                    log('Paso 4: No se encontraron actualizaciones para aplicar.');
                }

                log(`游꿀 Proceso completado. Jugadores actualizados: ${updatedCount}, Omitidos: ${skippedCount}.`);
                
                if (skippedPlayersReport.length > 0) {
                    log('\n--- DETALLE DE JUGADORES OMITIDOS ---');
                    skippedPlayersReport.forEach(report => {
                        log(`- Jugador: ${report.name} (DNI: ${report.dni}) | Motivo: ${report.reason}`);
                    });
                    log('--- FIN DEL DETALLE ---');
                }

                startBtn.textContent = 'Completado';

            } catch (error) {
                log(`Ocurri칩 un error general: ${error.message}`, true);
                startBtn.disabled = false;
                startBtn.textContent = 'Reintentar Importaci칩n';
            }
        });
    </script>
</body>